name: Sync Upstream

on:
  schedule:
    - cron: '*/30 * * * *'  # 每30分钟同步一次
  workflow_dispatch:  # 手动触发

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/op7418/CodePilot.git

      - name: Fetch upstream
        run: git fetch upstream

      - name: Check for updates
        id: check
        run: |
          LOCAL=$(git rev-parse HEAD)
          UPSTREAM=$(git rev-parse upstream/main)
          if [ "$LOCAL" = "$UPSTREAM" ] || git merge-base --is-ancestor upstream/main HEAD; then
            echo "No new commits from upstream"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "Upstream has new commits"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Rebase onto upstream
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git checkout main
          git rebase upstream/main

      - name: Push changes
        if: steps.check.outputs.has_updates == 'true'
        run: git push origin main --force-with-lease

      - name: Get version and create release tag
        if: steps.check.outputs.has_updates == 'true'
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="v${VERSION}-build.${TIMESTAMP}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}
