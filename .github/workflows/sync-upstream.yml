name: Sync Upstream

on:
  schedule:
    - cron: '*/30 * * * *'  # 每30分钟同步一次
  workflow_dispatch:  # 手动触发

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/op7418/CodePilot.git

      - name: Fetch upstream with tags
        run: git fetch upstream --tags

      - name: Check for upstream version update
        id: check
        run: |
          # 获取上游最新版本号
          UPSTREAM_VERSION=$(git show upstream/main:package.json | grep '"version"' | sed 's/.*"version": *"\([^"]*\)".*/\1/')
          echo "Upstream version: $UPSTREAM_VERSION"

          # 检查本地是否已有该版本的 release tag
          if git tag -l "v${UPSTREAM_VERSION}" | grep -q "v${UPSTREAM_VERSION}"; then
            echo "Version v${UPSTREAM_VERSION} already released"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected: v${UPSTREAM_VERSION}"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Rebase onto upstream
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git checkout main
          git rebase upstream/main

      - name: Push changes
        if: steps.check.outputs.has_updates == 'true'
        run: git push origin main --force-with-lease

      - name: Create and push version tag
        if: steps.check.outputs.has_updates == 'true'
        run: |
          VERSION=${{ steps.check.outputs.version }}
          git tag "v${VERSION}"
          git push origin "v${VERSION}"
          echo "Created and pushed tag: v${VERSION}"
